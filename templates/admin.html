<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Task Manager ‚Äî –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-alt: #020617;
      --card: #020617;
      --card-soft: #0b1120;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.1);
      --ok: #4ade80;
      --ok-soft: rgba(74, 222, 128, 0.12);
      --border: #1e293b;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --muted-soft: #1f2937;
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.75);
      --shadow-light: 0 10px 25px rgba(15, 23, 42, 0.65);
      --transition-fast: 0.16s ease-out;
      --transition-slow: 0.28s ease;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 48%, #000 100%);
      color: var(--text);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px 18px 26px;
      gap: 16px;
    }

    header.header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 10px;
      z-index: 20;
      backdrop-filter: blur(18px);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 13px;
      color: #e5e7eb;
    }

    .logo-pill {
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #facc15, #f97316 40%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      color: #020617;
      box-shadow: 0 4px 18px rgba(251, 191, 36, 0.6);
    }

    .logo-sub {
      font-size: 11px;
      color: var(--muted);
      text-transform: none;
      letter-spacing: 0;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-label {
      font-size: 12px;
      color: var(--muted);
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148, 163, 184, 0.25);
      max-width: 260px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .role-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
    }

    .role-chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.65);
    }

    .btn,
    .btn-secondary,
    .btn-danger,
    .btn-ghost {
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      border-radius: var(--radius-pill);
      padding: 7px 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast);
      white-space: nowrap;
    }

    .btn {
      background: linear-gradient(135deg, var(--accent), #0ea5e9);
      color: #020617;
      box-shadow: 0 12px 26px rgba(56, 189, 248, 0.45);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(56, 189, 248, 0.55);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      border: 1px solid rgba(148, 163, 184, 0.32);
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
      border-color: rgba(148, 163, 184, 0.6);
      transform: translateY(-1px);
      box-shadow: var(--shadow-light);
    }

    .btn-danger {
      background: var(--danger-soft);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.6);
    }

    .btn-danger:hover {
      background: rgba(248, 113, 113, 0.22);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid transparent;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.8);
      border-color: rgba(148, 163, 184, 0.28);
      color: var(--text);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 11px;
    }

    .btn-icon {
      padding: 5px;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      justify-content: center;
    }

    .btn[disabled],
    .btn-secondary[disabled],
    .btn-danger[disabled],
    .btn-ghost[disabled] {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    main {
      display: grid;
      grid-template-columns: 3fr 2fr;
      gap: 14px;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 1024px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: radial-gradient(circle at top left, #020617 0, #020617 45%, #020617 100%);
      border-radius: var(--radius-lg);
      padding: 14px 14px 12px;
      border: 1px solid rgba(30, 64, 175, 0.6);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.1), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
    }

    .pill.blue {
      border-color: rgba(56, 189, 248, 0.75);
      color: #7dd3fc;
      background: rgba(15, 23, 42, 0.9);
    }

    .pill.green {
      border-color: rgba(74, 222, 128, 0.75);
      color: #bbf7d0;
      background: rgba(15, 23, 42, 0.9);
    }

    .pill.red {
      border-color: rgba(248, 113, 113, 0.75);
      color: #fecaca;
      background: rgba(15, 23, 42, 0.9);
    }

    .alert {
      border-radius: 12px;
      padding: 8px 11px;
      margin-bottom: 8px;
      font-size: 12px;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }

    .alert-error {
      background: var(--danger-soft);
      border: 1px solid rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .alert-success {
      background: var(--ok-soft);
      border: 1px solid rgba(74, 222, 128, 0.7);
      color: #bbf7d0;
    }

    .alert span.icon {
      font-size: 14px;
      margin-top: 1px;
    }

    .alert ul {
      margin: 4px 0 0;
      padding-left: 16px;
      font-size: 11px;
    }

    .hidden {
      display: none !important;
    }

    .grid {
      display: grid;
      gap: 10px;
    }

    .grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    label span.req {
      color: #fb7185;
      font-size: 10px;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="date"],
    select,
    textarea {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 10px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 7px 10px;
      font-size: 12px;
      color: var(--text);
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
      width: 100%;
      font-family: inherit;
      resize: vertical;
      min-height: 0;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(148, 163, 184, 0.68);
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
      background: rgba(15, 23, 42, 1);
    }

    textarea {
      min-height: 52px;
      max-height: 140px;
    }

    .field-inline {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .password-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .password-toggle {
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 3px 7px;
      font-size: 10px;
      color: var(--muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 3px;
      transition: background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast);
    }

    .password-toggle:hover {
      background: rgba(15,23,42,1);
      border-color: rgba(148,163,184,0.7);
      color: var(--text);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      font-size: 10px;
      color: var(--muted);
      gap: 4px;
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .tag-status-–í—ã–ø–æ–ª–Ω–µ–Ω–∞,
    .tag-status-¬´–≤—ã–ø–æ–ª–Ω–µ–Ω–∞¬ª {
      border-color: rgba(74, 222, 128, 0.7);
      color: #bbf7d0;
    }

    .tag-status-¬´–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ¬ª,
    .tag-status-–í-–ø—Ä–æ—Ü–µ—Å—Å–µ {
      border-color: rgba(56, 189, 248, 0.75);
      color: #7dd3fc;
    }

    .tag-status-¬´–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é¬ª {
      border-color: rgba(148, 163, 184, 0.75);
    }

    .tag-priority-–≤—ã—Å–æ–∫–∏–π {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    .tag-priority-—Å—Ä–µ–¥–Ω–∏–π {
      border-color: rgba(56, 189, 248, 0.8);
      color: #7dd3fc;
    }

    .tag-priority-–Ω–∏–∑–∫–∏–π {
      border-color: rgba(148, 163, 184, 0.8);
      color: #e5e7eb;
    }

    .role-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      gap: 4px;
    }

    .role-badge.user {
      border-color: rgba(148, 163, 184, 0.7);
    }

    .role-badge.admin {
      border-color: rgba(56, 189, 248, 0.9);
      color: #7dd3fc;
    }

    .role-badge.super_admin {
      border-color: rgba(251, 191, 36, 0.9);
      color: #facc15;
    }

    .role-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .role-badge.admin .role-dot {
      background: rgba(56, 189, 248, 0.9);
    }

    .role-badge.super_admin .role-dot {
      background: rgba(251, 191, 36, 1);
      box-shadow: 0 0 8px rgba(251, 191, 36, 0.7);
    }

    .tabs {
      display: flex;
      border-radius: 999px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(30, 64, 175, 0.7);
      padding: 3px;
      gap: 4px;
      margin-bottom: 8px;
    }

    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 5px 6px;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }

    .tab-btn span.icon {
      font-size: 13px;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.18), rgba(59,130,246,0.12));
      color: #e5e7eb;
      transform: translateY(-0.5px);
    }

    .section {
      margin-top: 6px;
    }

    .section-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 6px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .section-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .table-wrapper {
      border-radius: 12px;
      border: 1px solid rgba(30, 64, 175, 0.6);
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), #020617 70%);
      overflow: hidden;
      max-height: 290px;
      display: flex;
      flex-direction: column;
    }

    .table-body-scroll {
      overflow: auto;
      max-height: 236px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    thead {
      background: rgba(15, 23, 42, 0.98);
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.55);
      text-align: left;
      vertical-align: middle;
    }

    th {
      font-weight: 500;
      color: var(--muted);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    tr {
      transition: background var(--transition-fast);
    }

    tbody tr:hover {
      background: rgba(15, 23, 42, 0.85);
    }

    .row-selected {
      background: rgba(56, 189, 248, 0.12);
    }

    .mono {
      font-family: ui-monospace, Menlo, Monaco, Consolas, "SF Mono", "Roboto Mono", monospace;
    }

    .pill-small {
      border-radius: 999px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 1px 6px;
      font-size: 10px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 7px;
      margin-bottom: 8px;
    }

    @media (max-width: 1100px) {
      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 780px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(30, 64, 175, 0.7);
      padding: 7px 8px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .stat-label {
      font-size: 10px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-value {
      font-size: 15px;
      font-weight: 600;
    }

    .stat-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .comment-list {
      border-radius: 12px;
      border: 1px solid rgba(30, 64, 175, 0.6);
      background: rgba(15, 23, 42, 0.96);
      max-height: 193px;
      overflow: auto;
      padding: 6px 7px 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .comment-item {
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(30, 64, 175, 0.7);
      padding: 5px 7px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .comment-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
    }

    .comment-author {
      font-size: 11px;
      color: #e5e7eb;
      font-weight: 500;
    }

    .comment-meta {
      font-size: 10px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .comment-text {
      font-size: 11px;
      color: #e5e7eb;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .comment-actions {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
      margin-top: 3px;
    }

    .login-card {
      max-width: 360px;
      margin: 40px auto 0;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #020617 0, #020617 50%, #020617 100%);
      border: 1px solid rgba(30, 64, 175, 0.8);
      box-shadow: var(--shadow-soft);
      padding: 18px 16px 14px;
    }

    .login-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .login-sub {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .link-hint {
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
    }

    .token-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .token-dot.offline {
      background: #f97373;
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.9);
    }

    .flex-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .mt-4 {
      margin-top: 8px;
    }

    .mt-6 {
      margin-top: 10px;
    }

    .mt-8 {
      margin-top: 12px;
    }

    .mt-10 {
      margin-top: 16px;
    }
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="logo">
      <div class="logo-pill">TM</div>
      <div>
        <div>Task Manager API</div>
        <div class="logo-sub">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (Flask + SQLite)</div>
      </div>
    </div>
    <div class="header-right">
      <div class="user-label" id="current-user-label">
        –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      </div>
      <button id="logout-btn" class="btn-secondary btn-sm hidden" type="button">
        <span>–í—ã–π—Ç–∏</span>
      </button>
    </div>
  </header>

  <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã -->
  <div id="error-box" class="alert alert-error hidden">
    <span class="icon">‚ö†Ô∏è</span>
    <div>
      <div id="error-message">–û—à–∏–±–∫–∞</div>
      <ul id="error-details"></ul>
    </div>
  </div>

  <div id="success-box" class="alert alert-success hidden">
    <span class="icon">‚úÖ</span>
    <div id="success-message">–£—Å–ø–µ—à–Ω–æ</div>
  </div>

  <main>
    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –ª–æ–≥–∏–Ω –ò–õ–ò –∑–∞–¥–∞—á–∏/–∫–æ–º–º–µ–Ω—Ç—ã -->
    <section id="left-panel">
      <!-- –ë–ª–æ–∫ –ª–æ–≥–∏–Ω–∞ -->
      <div id="login-section" class="login-card">
        <div class="login-title">–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
        <div class="login-sub">
          –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç <span class="mono">admin@mail.ru / 123456</span>
          –∏–ª–∏ –ª—é–±–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ä–æ–ª—å—é <span class="mono">admin</span> –∏–ª–∏ <span class="mono">super_admin</span>.
        </div>

        <form id="login-form">
          <div class="field-group">
            <label for="login-email">Email <span class="req">*</span></label>
            <input id="login-email" type="email" placeholder="admin@mail.ru" required />
          </div>
          <div class="field-group">
            <label for="login-password">–ü–∞—Ä–æ–ª—å <span class="req">*</span></label>
            <div class="password-wrapper">
              <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
              <button type="button" class="password-toggle" id="login-password-toggle">
                <span>üëÅ</span><span>–ü–æ–∫–∞–∑–∞—Ç—å</span>
              </button>
            </div>
          </div>
          <div class="flex-row mt-6">
            <button class="btn" type="submit">
              –í–æ–π—Ç–∏
            </button>
            <div class="flex-row" style="font-size: 10px; color: var(--muted);">
              <div class="token-dot offline" id="auth-status-dot"></div>
              <span id="auth-status-text">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
            </div>
          </div>
          <p class="link-hint">
            –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ —Ç–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ <span class="mono">localStorage</span>, –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—ã –æ—Å—Ç–∞–Ω–µ—Ç–µ—Å—å –≤ –ø–∞–Ω–µ–ª–∏.
          </p>
        </form>
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∞–¥–º–∏–Ω-—á–∞—Å—Ç—å —Å–ª–µ–≤–∞ (–∑–∞–¥–∞—á–∏/–∫–æ–º–º–µ–Ω—Ç—ã) -->
      <div id="tasks-section" class="card hidden">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">
                üìã –ó–∞–¥–∞—á–∏
                <span class="pill blue">API /api/tasks</span>
              </div>
              <div class="card-subtitle" id="tasks-subtitle">
                –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á, —Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
              </div>
            </div>
          </div>

          <div class="tabs" style="margin-bottom: 10px;">
            <button class="tab-btn active" data-tab="tasks-list">
              <span class="icon">üìë</span>
              <span>–ó–∞–¥–∞—á–∏</span>
            </button>
            <button class="tab-btn" data-tab="tasks-create">
              <span class="icon">‚ûï</span>
              <span>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</span>
            </button>
            <button class="tab-btn" data-tab="task-comments">
              <span class="icon">üí¨</span>
              <span>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–∞–¥–∞—á–µ</span>
            </button>
          </div>

          <!-- –¢–∞–±: –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
          <div id="tab-tasks-list" class="section">
            <div class="section-title-row">
              <div>
                <div class="section-title">–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</div>
                <div class="section-sub">–ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
              </div>
              <div class="flex-row">
                <select id="task-status-filter">
                  <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                  <option value="–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é">–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</option>
                  <option value="–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                  <option value="–≤—ã–ø–æ–ª–Ω–µ–Ω–∞">–í—ã–ø–æ–ª–Ω–µ–Ω–∞</option>
                  <option value="–æ—Ç–º–µ–Ω–µ–Ω–∞">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                </select>
                <button type="button" class="btn-secondary btn-sm" id="refresh-tasks-btn">
                  –û–±–Ω–æ–≤–∏—Ç—å
                </button>
              </div>
            </div>

            <div class="table-wrapper">
              <div class="table-body-scroll">
                <table>
                  <thead>
                  <tr>
                    <th>ID</th>
                    <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                    <th>–ê–≤—Ç–æ—Ä</th>
                    <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                    <th>–°—Ä–æ–∫</th>
                    <th></th>
                  </tr>
                  </thead>
                  <tbody id="tasks-table-body">
                  <!-- –†–µ–Ω–¥–µ—Ä –∑–∞–¥–∞—á -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- –¢–∞–±: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
          <div id="tab-tasks-create" class="section hidden">
            <div class="section-title-row">
              <div>
                <div class="section-title">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</div>
                <div class="section-sub">–°–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç –∏–º–µ–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
              </div>
            </div>
            <form id="create-task-form">
              <div class="field-group">
                <label for="task-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ <span class="req">*</span></label>
                <input id="task-title" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä" required />
              </div>
              <div class="field-group">
                <label for="task-desc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="task-desc" placeholder="–ö—Ä–∞—Ç–∫–æ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å"></textarea>
              </div>
              <div class="grid grid-2">
                <div class="field-group">
                  <label for="task-status">–°—Ç–∞—Ç—É—Å</label>
                  <select id="task-status">
                    <option value="–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é">–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</option>
                    <option value="–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                    <option value="–≤—ã–ø–æ–ª–Ω–µ–Ω–∞">–í—ã–ø–æ–ª–Ω–µ–Ω–∞</option>
                    <option value="–æ—Ç–º–µ–Ω–µ–Ω–∞">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                  </select>
                </div>
                <div class="field-group">
                  <label for="task-priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                  <select id="task-priority">
                    <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
                    <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
                    <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-2">
                <div class="field-group">
                  <label for="task-due">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                  <input id="task-due" type="date" />
                </div>
                <div class="field-group">
                  <label for="task-executor">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                  <select id="task-executor">
                    <option value="">‚Äî –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω ‚Äî</option>
                    <!-- –Ω–∞–ø–æ–ª–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
                  </select>
                </div>
              </div>
              <div class="flex-row mt-6">
                <button class="btn" type="submit" id="task-submit-btn">
                  –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                </button>
                <button type="button" class="btn-ghost btn-sm hidden" id="cancel-edit-task-btn">
                  –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                </button>
                <span class="section-sub">
                  –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                </span>
              </div>
            </form>
          </div>

          <!-- –¢–∞–±: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–¥–∞—á–µ -->
          <div id="tab-task-comments" class="section hidden">
            <div class="section-title-row">
              <div>
                <div class="section-title">
                  –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                  <span id="comments-task-label" class="section-sub">(–∑–∞–¥–∞—á–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞)</span>
                </div>
                <div class="section-sub">
                  –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –≤ —Ç–∞–±–ª–∏—Ü–µ –≤—ã—à–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ
                </div>
              </div>
              <button id="reload-comments-btn" type="button" class="btn-secondary btn-sm">
                –û–±–Ω–æ–≤–∏—Ç—å
              </button>
            </div>

            <div class="comment-list" id="comments-list">
              <!-- —Å—é–¥–∞ –ø—Ä–∏–ª–µ—Ç—è—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
            </div>

            <form id="comment-form" class="mt-8">
              <div class="field-group">
                <label for="comment-text">–ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="comment-text" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –∑–∞–¥–∞—á–µ"></textarea>
              </div>
              <div class="flex-row" style="justify-content: space-between; gap: 8px;">
                <div class="section-sub" id="comment-edit-hint">
                  –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –∏–∑–º–µ–Ω—ë–Ω –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                </div>
                <div class="flex-row" style="gap: 6px;">
                  <button type="button" id="cancel-edit-comment-btn" class="btn-ghost btn-sm hidden">
                    –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                  </button>
                  <button type="submit" class="btn btn-sm">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </button>
                </div>
              </div>
            </form>
          </div>

        </div>
      </div>
    </section>

    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <section id="right-panel" class="card hidden">
      <div class="card-inner">
        <div class="card-header">
          <div>
            <div class="card-title">
              üõ† –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ & —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
              <span class="pill green">/admin</span>
            </div>
            <div class="card-subtitle">
              –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Ä–æ–ª–∏, —Ç–æ–∫–µ–Ω—ã, –æ–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∑–∞–¥–∞—á
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">
              –í—Å–µ–≥–æ –∑–∞–¥–∞—á
              <span class="tag">
                <span class="tag-dot"></span>
                live –∏–∑ /admin/stats
              </span>
            </div>
            <div class="stat-value" id="stat-total-tasks">‚Äî</div>
            <div class="stat-chip-row" id="stat-by-status">
              <!-- —á–∏–ø—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–¥–∞—á</div>
            <div class="stat-value" id="stat-priority-main">‚Äî</div>
            <div class="stat-chip-row" id="stat-by-priority">
              <!-- —á–∏–ø—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º -->
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">
              –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            </div>
            <div class="stat-value" id="stat-active-users">‚Äî</div>
            <div class="stat-chip-row" id="stat-active-users-extra">
              <!-- —á–∏–ø—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
            </div>
          </div>
        </div>

        <div class="section mt-4">
          <div class="section-title-row">
            <div>
              <div class="section-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
              <div class="section-sub">
                –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π, —É–¥–∞–ª–µ–Ω–∏–µ
              </div>
            </div>
            <button id="refresh-users-btn" type="button" class="btn-secondary btn-sm">
              –û–±–Ω–æ–≤–∏—Ç—å
            </button>
          </div>

          <form id="create-user-form" class="mt-4">
            <div class="grid grid-2">
              <div class="field-group">
                <label for="user-email">Email <span class="req">*</span></label>
                <input id="user-email" type="email" placeholder="user@mail.ru" required />
              </div>
              <div class="field-group">
                <label for="user-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <span class="req">*</span></label>
                <input id="user-username" type="text" placeholder="–ò–º—è" required />
              </div>
            </div>
            <div class="grid grid-2">
              <div class="field-group">
                <label for="user-password">–ü–∞—Ä–æ–ª—å <span class="req">*</span></label>
                <div class="password-wrapper">
                  <input id="user-password" type="password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" required />
                  <button type="button" class="password-toggle" id="user-password-toggle">
                    <span>üëÅ</span><span>–ü–æ–∫–∞–∑–∞—Ç—å</span>
                  </button>
                </div>
              </div>
              <div class="field-group">
                <label for="user-role">–†–æ–ª—å</label>
                <select id="user-role">
                  <option value="user">–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                  <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                </select>
              </div>
            </div>
            <div class="flex-row mt-4">
              <button class="btn btn-sm" type="submit">
                –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
              </button>
              <span class="section-sub">
                –ü–∞—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ö—ç—à–µ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ ‚Äî ‚â• 6 —Å–∏–º–≤–æ–ª–æ–≤
              </span>
            </div>
          </form>

          <div class="mt-6 table-wrapper">
            <div class="table-body-scroll">
              <table>
                <thead>
                <tr>
                  <th>ID</th>
                  <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                  <th>–ü–æ—á—Ç–∞</th>
                  <th>–†–æ–ª—å</th>
                  <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                  <th></th>
                </tr>
                </thead>
                <tbody id="users-table-body">
                <!-- –†–µ–Ω–¥–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>
</div>

<script>
// === –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ===
let authToken = localStorage.getItem("authToken") || null;
let currentUser = null;
let activeUsers = [];
let selectedTaskId = null;
let editingCommentId = null;
let editingTaskId = null;

const errorBox = document.getElementById("error-box");
const errorMessage = document.getElementById("error-message");
const errorDetails = document.getElementById("error-details");
const successBox = document.getElementById("success-box");
const successMessage = document.getElementById("success-message");

function hideAlerts() {
  errorBox.classList.add("hidden");
  successBox.classList.add("hidden");
}

function showError(err) {
  console.error("API error:", err);
  const msg = err && err.message ? err.message : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
  errorMessage.textContent = msg;
  errorDetails.innerHTML = "";

  if (err && Array.isArray(err.details) && err.details.length) {
    for (const d of err.details) {
      const li = document.createElement("li");
      li.textContent = d;
      errorDetails.appendChild(li);
    }
  }

  successBox.classList.add("hidden");
  errorBox.classList.remove("hidden");

  setTimeout(() => {
    errorBox.classList.add("hidden");
  }, 5000);
}

function showSuccess(msg) {
  successMessage.textContent = msg || "–£—Å–ø–µ—à–Ω–æ";
  errorBox.classList.add("hidden");
  successBox.classList.remove("hidden");
  setTimeout(() => {
    successBox.classList.add("hidden");
  }, 3000);
}

async function apiFetch(url, options = {}) {
  const headers = options.headers || {};
  if (authToken) {
    headers["Authorization"] = `Bearer ${authToken}`;
  }
  if (!headers["Content-Type"] && options.method && options.method !== "GET") {
    headers["Content-Type"] = "application/json";
  }

  const resp = await fetch(url, { ...options, headers });

  let data = {};
  try {
    data = await resp.json();
  } catch (e) {
    // no JSON in response
  }

  if (resp.status === 401) {
    await handleLogout(false);
    const err = new Error(data.error || "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è");
    err.status = resp.status;
    err.details = data.details;
    throw err;
  }

  if (!resp.ok) {
    const err = new Error(data.error || data.message || "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞");
    err.status = resp.status;
    err.details = data.details;
    throw err;
  }

  return data;
}

function setAuthUIState(isAuthenticated) {
  const label = document.getElementById("current-user-label");
  const dot = document.getElementById("auth-status-dot");
  const text = document.getElementById("auth-status-text");
  const logoutBtn = document.getElementById("logout-btn");

  if (isAuthenticated && currentUser) {
    label.innerHTML = `
      <span>${currentUser.username}</span>
      <span style="opacity:0.7;">(${currentUser.email})</span>
    `;
    dot.classList.remove("offline");
    text.textContent = "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
    logoutBtn.classList.remove("hidden");
  } else {
    label.textContent = "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
    dot.classList.add("offline");
    text.textContent = "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
    logoutBtn.classList.add("hidden");
  }
}

function showLoginForm() {
  document.getElementById("login-section").classList.remove("hidden");
  document.getElementById("tasks-section").classList.add("hidden");
  document.getElementById("right-panel").classList.add("hidden");
}

function showAdminUI() {
  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("tasks-section").classList.remove("hidden");
  document.getElementById("right-panel").classList.remove("hidden");
}

async function handleLogout(callServer = true) {
  try {
    if (callServer && authToken) {
      await fetch("/auth/logout", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${authToken}`,
          "Content-Type": "application/json"
        }
      });
    }
  } catch (e) {
    console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ logout, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º:", e);
  } finally {
    authToken = null;
    currentUser = null;
    localStorage.removeItem("authToken");
    setAuthUIState(false);
    showLoginForm();
  }
}

async function handleLogin(event) {
  event.preventDefault();
  hideAlerts();
  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value;

  if (!email || !password) {
    showError(new Error("–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å"));
    return;
  }

  try {
    const data = await apiFetch("/auth/login", {
      method: "POST",
      body: JSON.stringify({ email, password })
    });

    authToken = data.token;
    localStorage.setItem("authToken", authToken);
    currentUser = data.user;
    setAuthUIState(true);
    showAdminUI();
    showSuccess("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞");
    await loadAllData();
  } catch (e) {
    showError(e);
  }
}

async function loadMeAndInit() {
  if (!authToken) {
    showLoginForm();
    setAuthUIState(false);
    return;
  }

  try {
    const data = await apiFetch("/users/me");
    currentUser = data.user;
    setAuthUIState(true);
    showAdminUI();
    await loadAllData();
  } catch (e) {
    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é:", e);
    await handleLogout(false);
  }
}

async function loadAllData() {
  hideAlerts();
  await Promise.all([
    loadStatsAndUsers(),
    loadTasks()
  ]);
}

async function loadStatsAndUsers() {
  try {
    const data = await apiFetch("/admin/stats");
    const stats = data.stats || {};
    activeUsers = data.active_users || [];
    renderStats(stats, activeUsers);
    renderUsers(activeUsers);
    fillExecutorSelect(activeUsers);
  } catch (e) {
    showError(e);
  }
}

async function loadTasks() {
  try {
    const statusFilter = document.getElementById("task-status-filter").value;
    const params = new URLSearchParams();
    params.set("limit", "50");
    if (statusFilter) params.set("status", statusFilter);

    const data = await apiFetch("/api/tasks?" + params.toString());
    renderTasks(data.tasks || []);
  } catch (e) {
    showError(e);
  }
}

function renderStats(stats, users) {
  const byStatus = stats.by_status || {};
  const byPriority = stats.by_priority || {};
  let totalTasks = 0;

  for (const val of Object.values(byStatus)) {
    totalTasks += Number(val) || 0;
  }
  document.getElementById("stat-total-tasks").textContent = totalTasks || "0";

  const statusContainer = document.getElementById("stat-by-status");
  statusContainer.innerHTML = "";
  for (const [status, count] of Object.entries(byStatus)) {
    const span = document.createElement("span");
    span.className = "pill-small";
    span.textContent = `${status}: ${count}`;
    statusContainer.appendChild(span);
  }

  const priorityContainer = document.getElementById("stat-by-priority");
  priorityContainer.innerHTML = "";
  let maxPriority = "‚Äî";
  let maxValue = 0;
  for (const [p, count] of Object.entries(byPriority)) {
    const c = Number(count) || 0;
    if (c > maxValue) {
      maxValue = c;
      maxPriority = p;
    }
    const span = document.createElement("span");
    span.className = "pill-small";
    span.textContent = `${p}: ${count}`;
    priorityContainer.appendChild(span);
  }
  document.getElementById("stat-priority-main").textContent = maxPriority;

  const activeUsersCount = users.length;
  document.getElementById("stat-active-users").textContent = activeUsersCount.toString();

  const activeExtra = document.getElementById("stat-active-users-extra");
  activeExtra.innerHTML = "";
  users
    .filter(u => (u.tasks_count || 0) > 0 || (u.comments_count || 0) > 0)
    .slice(0, 4)
    .forEach(u => {
      const span = document.createElement("span");
      span.className = "pill-small";
      span.textContent = `${u.username}: ${u.tasks_count || 0} –∑–∞–¥–∞—á, ${u.comments_count || 0} –∫–æ–º–º.`;
      activeExtra.appendChild(span);
    });
}

function renderUsers(users) {
  const tbody = document.getElementById("users-table-body");
  tbody.innerHTML = "";
  const meId = currentUser ? currentUser.id : null;
  const meRole = currentUser ? currentUser.role : null;

  users.forEach(user => {
    const tr = document.createElement("tr");

    const tdId = document.createElement("td");
    tdId.textContent = user.id;
    tdId.className = "mono";
    tr.appendChild(tdId);

    const tdName = document.createElement("td");
    tdName.textContent = user.username;
    tr.appendChild(tdName);

    const tdEmail = document.createElement("td");
    tdEmail.textContent = user.email;
    tr.appendChild(tdEmail);

    const tdRole = document.createElement("td");
    const badge = document.createElement("span");
    badge.className = `role-badge ${user.role}`;
    const dot = document.createElement("span");
    dot.className = "role-dot";
    const label = document.createElement("span");
    label.textContent =
      user.role === "super_admin"
        ? "–°—É–ø–µ—Ä –∞–¥–º–∏–Ω"
        : user.role === "admin"
        ? "–ê–¥–º–∏–Ω"
        : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
    badge.appendChild(dot);
    badge.appendChild(label);
    tdRole.appendChild(badge);
    tr.appendChild(tdRole);

    const tdActivity = document.createElement("td");
    const tCount = user.tasks_count || 0;
    const cCount = user.comments_count || 0;
    tdActivity.textContent = `–ó–∞–¥–∞—á: ${tCount}, –∫–æ–º–º.: ${cCount}`;
    tr.appendChild(tdActivity);

    const tdActions = document.createElement("td");
    const actionsRow = document.createElement("div");
    actionsRow.style.display = "flex";
    actionsRow.style.gap = "4px";

    const canChangeRoles =
      meRole === "super_admin" && user.id !== meId;

    const btnMakeAdmin = document.createElement("button");
    btnMakeAdmin.type = "button";
    btnMakeAdmin.className = "btn-ghost btn-sm";
    btnMakeAdmin.textContent = "–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º";
    btnMakeAdmin.disabled = !canChangeRoles || user.role === "admin" || user.role === "super_admin";
    btnMakeAdmin.addEventListener("click", () => changeUserRole(user.id, "admin"));
    actionsRow.appendChild(btnMakeAdmin);

    const btnMakeUser = document.createElement("button");
    btnMakeUser.type = "button";
    btnMakeUser.className = "btn-ghost btn-sm";
    btnMakeUser.textContent = "–°–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º";
    btnMakeUser.disabled = !canChangeRoles || user.role === "user";
    btnMakeUser.addEventListener("click", () => changeUserRole(user.id, "user"));
    actionsRow.appendChild(btnMakeUser);

    const btnDelete = document.createElement("button");
    btnDelete.type = "button";
    btnDelete.className = "btn-danger btn-sm";
    btnDelete.textContent = "–£–¥–∞–ª–∏—Ç—å";
    btnDelete.disabled = user.id === meId || user.role === "super_admin";
    btnDelete.addEventListener("click", () => deleteUser(user.id));
    actionsRow.appendChild(btnDelete);

    tdActions.appendChild(actionsRow);
    tr.appendChild(tdActions);

    tbody.appendChild(tr);
  });
}

async function changeUserRole(userId, role) {
  hideAlerts();
  try {
    await apiFetch(`/admin/users/${userId}/role`, {
      method: "PUT",
      body: JSON.stringify({ role })
    });
    showSuccess("–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
    await loadStatsAndUsers();
  } catch (e) {
    showError(e);
  }
}

async function deleteUser(userId) {
  hideAlerts();
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è #" + userId + " –≤–º–µ—Å—Ç–µ —Å –µ–≥–æ –∑–∞–¥–∞—á–∞–º–∏/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏?")) {
    return;
  }
  try {
    await apiFetch(`/admin/users/${userId}`, {
      method: "DELETE"
    });
    showSuccess("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω");
    await loadStatsAndUsers();
  } catch (e) {
    showError(e);
  }
}

function fillExecutorSelect(users) {
  const select = document.getElementById("task-executor");
  if (!select) return;
  const currentValue = select.value;
  select.innerHTML = "";
  const optNone = document.createElement("option");
  optNone.value = "";
  optNone.textContent = "‚Äî –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω ‚Äî";
  select.appendChild(optNone);

  users.forEach(u => {
    const opt = document.createElement("option");
    opt.value = u.id;
    opt.textContent = `${u.username} (${u.email})`;
    if (currentUser && u.id === currentUser.id) {
      opt.textContent += " ‚Äî —è";
    }
    select.appendChild(opt);
  });

  if (currentUser) {
    select.value = currentUser.id.toString();
  } else {
    select.value = currentValue || "";
  }
}

function renderTasks(tasks) {
  const tbody = document.getElementById("tasks-table-body");
  tbody.innerHTML = "";

  tasks.forEach(task => {
    const tr = document.createElement("tr");
    tr.dataset.taskId = task.id;

    if (task.id === selectedTaskId) {
      tr.classList.add("row-selected");
    }

    const tdId = document.createElement("td");
    tdId.textContent = task.id;
    tdId.className = "mono";
    tr.appendChild(tdId);

    const tdTitle = document.createElement("td");
    tdTitle.textContent = task.title;
    tr.appendChild(tdTitle);

    const tdStatus = document.createElement("td");
    const statusTag = document.createElement("span");
    statusTag.className = "tag";
    statusTag.textContent = task.status;
    tdStatus.appendChild(statusTag);
    tr.appendChild(tdStatus);

    const tdPriority = document.createElement("td");
    const pTag = document.createElement("span");
    pTag.className = "tag tag-priority-" + (task.priority || "").toLowerCase();
    pTag.textContent = task.priority || "‚Äî";
    tdPriority.appendChild(pTag);
    tr.appendChild(tdPriority);

    const tdAuthor = document.createElement("td");
    tdAuthor.textContent = task.author_name || `#${task.author_id}`;
    tr.appendChild(tdAuthor);

    const tdExec = document.createElement("td");
    tdExec.textContent = task.executor_name || (task.executor_id ? `#${task.executor_id}` : "‚Äî");
    tr.appendChild(tdExec);

    const tdDue = document.createElement("td");
    tdDue.textContent = task.due_date || "‚Äî";
    tr.appendChild(tdDue);

    const tdActions = document.createElement("td");
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.gap = "4px";

    const btnEdit = document.createElement("button");
    btnEdit.type = "button";
    btnEdit.className = "btn-ghost btn-icon btn-sm";
    btnEdit.textContent = "‚úèÔ∏è";
    btnEdit.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É";
    btnEdit.addEventListener("click", (ev) => {
      ev.stopPropagation();
      openTaskEditForm(task);
    });
    row.appendChild(btnEdit);

    const btnDelete = document.createElement("button");
    btnDelete.type = "button";
    btnDelete.className = "btn-danger btn-icon btn-sm";
    btnDelete.textContent = "‚úñ";
    btnDelete.title = "–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É";
    btnDelete.addEventListener("click", (ev) => {
      ev.stopPropagation();
      deleteTask(task.id);
    });
    row.appendChild(btnDelete);

    tdActions.appendChild(row);
    tr.appendChild(tdActions);

    tr.addEventListener("click", () => {
      selectedTaskId = task.id;
      highlightSelectedTask();
      updateCommentsTaskLabel(task);
      loadComments(task.id);
      switchTab("task-comments");
    });

    tbody.appendChild(tr);
  });
}

function highlightSelectedTask() {
  const rows = document.querySelectorAll("#tasks-table-body tr");
  rows.forEach(r => {
    if (Number(r.dataset.taskId) === selectedTaskId) {
      r.classList.add("row-selected");
    } else {
      r.classList.remove("row-selected");
    }
  });
}

async function deleteTask(taskId) {
  hideAlerts();
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É #" + taskId + "?")) {
    return;
  }
  try {
    await apiFetch(`/api/tasks/${taskId}`, {
      method: "DELETE"
    });
    showSuccess("–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞");
    if (selectedTaskId === taskId) {
      selectedTaskId = null;
      document.getElementById("comments-list").innerHTML = "";
      document.getElementById("comments-task-label").textContent = "(–∑–∞–¥–∞—á–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞)";
    }
    await loadTasks();
    await loadStatsAndUsers();
  } catch (e) {
    showError(e);
  }
}

function resetTaskForm() {
  editingTaskId = null;
  const form = document.getElementById("create-task-form");
  if (form) form.reset();
  fillExecutorSelect(activeUsers);
  const btn = document.getElementById("task-submit-btn");
  if (btn) btn.textContent = "–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É";
  const subtitle = document.getElementById("tasks-subtitle");
  if (subtitle) {
    subtitle.textContent = "–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á, —Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏";
  }
  const cancelBtn = document.getElementById("cancel-edit-task-btn");
  if (cancelBtn) cancelBtn.classList.add("hidden");
}

function openTaskEditForm(task) {
  if (!task) return;
  editingTaskId = task.id;
  switchTab("tasks-create");

  const titleInput = document.getElementById("task-title");
  const descInput = document.getElementById("task-desc");
  const statusSelect = document.getElementById("task-status");
  const prioritySelect = document.getElementById("task-priority");
  const dueInput = document.getElementById("task-due");
  const execSelect = document.getElementById("task-executor");

  if (titleInput) titleInput.value = task.title || "";
  if (descInput) descInput.value = task.description || "";
  if (statusSelect && task.status) statusSelect.value = task.status;
  if (prioritySelect && task.priority) prioritySelect.value = task.priority;
  if (dueInput) dueInput.value = task.due_date || "";
  if (execSelect) {
    execSelect.value = task.executor_id ? String(task.executor_id) : "";
  }

  const btn = document.getElementById("task-submit-btn");
  if (btn) btn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";

  const subtitle = document.getElementById("tasks-subtitle");
  if (subtitle) {
    subtitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ #${task.id}`;
  }

  const cancelBtn = document.getElementById("cancel-edit-task-btn");
  if (cancelBtn) cancelBtn.classList.remove("hidden");
}

async function handleTaskFormSubmit(event) {
  event.preventDefault();
  hideAlerts();
  if (!currentUser) {
    showError(new Error("–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å"));
    return;
  }

  const titleInput = document.getElementById("task-title");
  const descInput = document.getElementById("task-desc");
  const statusSelect = document.getElementById("task-status");
  const prioritySelect = document.getElementById("task-priority");
  const dueInput = document.getElementById("task-due");
  const execSelect = document.getElementById("task-executor");

  const title = titleInput ? titleInput.value.trim() : "";
  const description = descInput ? descInput.value.trim() : "";
  const status = statusSelect ? statusSelect.value : "–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é";
  const priority = prioritySelect ? prioritySelect.value : "—Å—Ä–µ–¥–Ω–∏–π";
  const due_date = dueInput && dueInput.value ? dueInput.value : null;
  const executor_id_raw = execSelect ? execSelect.value : "";
  const executor_id = executor_id_raw ? Number(executor_id_raw) : null;

  if (!title) {
    showError(new Error("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏"));
    return;
  }

  const common = {
    title,
    description,
    status,
    priority,
    due_date,
    executor_id
  };

  try {
    if (editingTaskId) {
      await apiFetch(`/api/tasks/${editingTaskId}`, {
        method: "PUT",
        body: JSON.stringify(common)
      });
      showSuccess("–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞");
    } else {
      const payload = {
        ...common,
        author_id: currentUser.id,
        executor_id: executor_id || currentUser.id
      };
      await apiFetch("/api/tasks", {
        method: "POST",
        body: JSON.stringify(payload)
      });
      showSuccess("–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞");
    }

    resetTaskForm();
    await loadTasks();
    await loadStatsAndUsers();
    switchTab("tasks-list");
  } catch (e) {
    showError(e);
  }
}

function updateCommentsTaskLabel(task) {
  const label = document.getElementById("comments-task-label");
  if (!task) {
    label.textContent = "(–∑–∞–¥–∞—á–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞)";
  } else {
    label.textContent = `(#${task.id}) ${task.title}`;
  }
}

async function loadComments(taskId) {
  hideAlerts();
  if (!taskId) {
    document.getElementById("comments-list").innerHTML = "";
    updateCommentsTaskLabel(null);
    return;
  }

  try {
    const data = await apiFetch(`/api/tasks/${taskId}/comments`);
    renderComments(data.comments || []);
  } catch (e) {
    showError(e);
  }
}

function renderComments(comments) {
  const container = document.getElementById("comments-list");
  container.innerHTML = "";
  if (!comments.length) {
    const p = document.createElement("p");
    p.className = "section-sub";
    p.textContent = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.";
    container.appendChild(p);
    return;
  }

  comments.forEach(c => {
    const item = document.createElement("div");
    item.className = "comment-item";

    const header = document.createElement("div");
    header.className = "comment-header";

    const author = document.createElement("div");
    author.className = "comment-author";
    author.textContent = c.author_name || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${c.author_id}`;
    header.appendChild(author);

    const meta = document.createElement("div");
    meta.className = "comment-meta";
    const created = document.createElement("span");
    created.textContent = c.created_at || "";
    meta.appendChild(created);
    header.appendChild(meta);
    item.appendChild(header);

    const text = document.createElement("div");
    text.className = "comment-text";
    text.textContent = c.text;
    item.appendChild(text);

    const actions = document.createElement("div");
    actions.className = "comment-actions";

    const canEditOrDelete =
      currentUser && (currentUser.id === c.author_id || currentUser.role === "admin" || currentUser.role === "super_admin");

    const btnEdit = document.createElement("button");
    btnEdit.type = "button";
    btnEdit.className = "btn-ghost btn-sm";
    btnEdit.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
    btnEdit.disabled = !canEditOrDelete;
    btnEdit.addEventListener("click", () => {
      startEditComment(c);
    });
    actions.appendChild(btnEdit);

    const btnDelete = document.createElement("button");
    btnDelete.type = "button";
    btnDelete.className = "btn-danger btn-sm";
    btnDelete.textContent = "–£–¥–∞–ª–∏—Ç—å";
    btnDelete.disabled = !canEditOrDelete;
    btnDelete.addEventListener("click", () => deleteComment(c.id));
    actions.appendChild(btnDelete);

    item.appendChild(actions);
    container.appendChild(item);
  });
}

function startEditComment(comment) {
  editingCommentId = comment.id;
  const textarea = document.getElementById("comment-text");
  textarea.value = comment.text;
  document.getElementById("comment-edit-hint").textContent =
    `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è #${comment.id}`;
  document
    .getElementById("cancel-edit-comment-btn")
    .classList.remove("hidden");
}

function resetCommentForm() {
  editingCommentId = null;
  const textarea = document.getElementById("comment-text");
  textarea.value = "";
  document.getElementById("comment-edit-hint").textContent =
    "–í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –∏–∑–º–µ–Ω—ë–Ω –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
  document
    .getElementById("cancel-edit-comment-btn")
    .classList.add("hidden");
}

async function deleteComment(commentId) {
  hideAlerts();
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π #" + commentId + "?")) return;

  try {
    await apiFetch(`/api/comments/${commentId}`, {
      method: "DELETE"
    });
    showSuccess("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª—ë–Ω");
    if (selectedTaskId) {
      await loadComments(selectedTaskId);
    }
  } catch (e) {
    showError(e);
  }
}

async function handleCommentSubmit(event) {
  event.preventDefault();
  hideAlerts();

  if (!currentUser) {
    showError(new Error("–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å"));
    return;
  }
  if (!selectedTaskId) {
    showError(new Error("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É"));
    return;
  }

  const text = document.getElementById("comment-text").value.trim();
  if (!text) {
    showError(new Error("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"));
    return;
  }

  try {
    if (editingCommentId) {
      await apiFetch(`/api/comments/${editingCommentId}`, {
        method: "PUT",
        body: JSON.stringify({ text })
      });
      showSuccess("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª—ë–Ω");
    } else {
      await apiFetch(`/api/tasks/${selectedTaskId}/comments`, {
        method: "POST",
        body: JSON.stringify({
          text,
          author_id: currentUser.id
        })
      });
      showSuccess("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω");
    }
    resetCommentForm();
    await loadComments(selectedTaskId);
  } catch (e) {
    showError(e);
  }
}

async function handleCreateUser(event) {
  event.preventDefault();
  hideAlerts();
  const email = document.getElementById("user-email").value.trim();
  const username = document.getElementById("user-username").value.trim();
  const password = document.getElementById("user-password").value;
  const role = document.getElementById("user-role").value;

  if (!email || !username || !password) {
    showError(new Error("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ email, –∏–º—è –∏ –ø–∞—Ä–æ–ª—å"));
    return;
  }

  try {
    await apiFetch("/auth/register", {
      method: "POST",
      body: JSON.stringify({ email, username, password, role })
    });
    showSuccess("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω");
    document.getElementById("create-user-form").reset();
    await loadStatsAndUsers();
  } catch (e) {
    showError(e);
  }
}

function switchTab(tabName) {
  const sections = {
    "tasks-list": document.getElementById("tab-tasks-list"),
    "tasks-create": document.getElementById("tab-tasks-create"),
    "task-comments": document.getElementById("tab-task-comments")
  };

  for (const key of Object.keys(sections)) {
    const sec = sections[key];
    if (!sec) continue;
    if (key === tabName) {
      sec.classList.remove("hidden");
    } else {
      sec.classList.add("hidden");
    }
  }

  const tabButtons = document.querySelectorAll(".tab-btn");
  tabButtons.forEach(btn => {
    const target = btn.getAttribute("data-tab");
    if (!target) return;
    if (target === tabName) {
      btn.classList.add("active");
    } else {
      btn.classList.remove("active");
    }
  });
}

function initTabs() {
  const btns = document.querySelectorAll(".tab-btn");
  btns.forEach(btn => {
    btn.addEventListener("click", () => {
      const tab = btn.getAttribute("data-tab");
      if (!tab) return;
      switchTab(tab);
    });
  });
  switchTab("tasks-list");
}

function initPasswordToggles() {
  const loginToggle = document.getElementById("login-password-toggle");
  const loginInput = document.getElementById("login-password");
  if (loginToggle && loginInput) {
    loginToggle.addEventListener("click", () => {
      togglePassword(loginInput, loginToggle);
    });
  }

  const userToggle = document.getElementById("user-password-toggle");
  const userInput = document.getElementById("user-password");
  if (userToggle && userInput) {
    userToggle.addEventListener("click", () => {
      togglePassword(userInput, userToggle);
    });
  }
}

function togglePassword(input, btn) {
  if (input.type === "password") {
    input.type = "text";
    btn.querySelector("span:nth-child(2)").textContent = "–°–∫—Ä—ã—Ç—å";
  } else {
    input.type = "password";
    btn.querySelector("span:nth-child(2)").textContent = "–ü–æ–∫–∞–∑–∞—Ç—å";
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const loginForm = document.getElementById("login-form");
  if (loginForm) {
    loginForm.addEventListener("submit", handleLogin);
  }

  const logoutBtn = document.getElementById("logout-btn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => handleLogout(true));
  }

  const taskForm = document.getElementById("create-task-form");
  if (taskForm) {
    taskForm.addEventListener("submit", handleTaskFormSubmit);
  }

  const cancelEditTaskBtn = document.getElementById("cancel-edit-task-btn");
  if (cancelEditTaskBtn) {
    cancelEditTaskBtn.addEventListener("click", resetTaskForm);
  }

  const commentForm = document.getElementById("comment-form");
  if (commentForm) {
    commentForm.addEventListener("submit", handleCommentSubmit);
  }

  const cancelEditCommentBtn = document.getElementById("cancel-edit-comment-btn");
  if (cancelEditCommentBtn) {
    cancelEditCommentBtn.addEventListener("click", () => resetCommentForm());
  }

  const refreshTasksBtn = document.getElementById("refresh-tasks-btn");
  if (refreshTasksBtn) {
    refreshTasksBtn.addEventListener("click", loadTasks);
  }

  const taskStatusFilter = document.getElementById("task-status-filter");
  if (taskStatusFilter) {
    taskStatusFilter.addEventListener("change", loadTasks);
  }

  const reloadCommentsBtn = document.getElementById("reload-comments-btn");
  if (reloadCommentsBtn) {
    reloadCommentsBtn.addEventListener("click", () => {
      if (selectedTaskId) loadComments(selectedTaskId);
    });
  }

  const createUserForm = document.getElementById("create-user-form");
  if (createUserForm) {
    createUserForm.addEventListener("submit", handleCreateUser);
  }

  const refreshUsersBtn = document.getElementById("refresh-users-btn");
  if (refreshUsersBtn) {
    refreshUsersBtn.addEventListener("click", loadStatsAndUsers);
  }

  initTabs();
  initPasswordToggles();
  loadMeAndInit();
});
</script>

</body>
</html>
